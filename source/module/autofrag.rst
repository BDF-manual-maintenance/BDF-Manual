分子自动分片，FLMO/iOI计算及能量分解分析 - AUTOFRAG模块
================================================

autofrag的主要功能是对大分子进行自动分片，并自动产生FLMO计算的输入。autofrag还是iOI-SCF的计算引擎，用于调度SCF的其他模块完成iOI计算。此外，autofrag还可利用卢天等开发的sobEDA、sobEDAw方法 :cite:`sobEDA` ，将分子片间的相互作用能分解为静电、位阻、轨道相互作用、色散等项的贡献。

autofrag模块主要计算流程为：

 * 根据分子坐标自动产生原子的键连信息；
 * 切断某些键，产生合适的分子片段；
 * 对分子片段增加缓冲原子；
 * 在断键处添加连接H原子或者投影杂化轨道PHO (Projected Hybrid Orbital);
 * 生成子体系分子片段的输入文件，利用并行化的模式计算分子片段；
 * 组织子体系分子片段计算结果，运行整体分子计算；
 * 若用户要求进行能量分解分析，计算分子片间的相互作用能，并分解为静电、位阻、轨道相互作用、色散等各组分的贡献。

``autofrag`` 必须放在 ``compass`` 之前。一般而言，在一个合法的BDF SCF单点能计算输入文件（采用高级输入语法，而非简洁输入语法）的前面增加一个合法的autofrag块，并在后面添加

.. code-block:: bdf

  $localmo
  FLMO
  $end

即得到一个合法的自动分片输入文件。注意$localmo块中的FLMO关键词对于autofrag支持的所有计算方法都要添加，并非只对于FLMO方法需要添加。

autofrag会处理 ``compass`` 模块中的分子结构，进行分子键判断，分片等。autofrag后的输入还被作为产生分子片段及整体计算输入的模版。利用autofrag做完整的例子见 :ref:`iOI-SCF计算示例<iOI-Example>`

注意：当使用 ``autofrag`` 模块时， ``compass`` 模块必须在直角坐标下定义分子坐标，且不能用 ``file=filename.xyz`` 语法从另一个文件里读入分子坐标。

:guilabel:`Method` 参数类型：字符串
------------------------------------------------
 * 默认值：FLMO
 * 可选值：FLMO、iOI、sobEDA、sobEDAw

设定计算方法。 FLMO - 计算分片定域化分子轨道；iOI - iOI-SCF计算，用分子片合成分子的方法计算大分子体系。iOI目前仅支持限制性自洽场计算；sobEDA/sobEDAw - 指定用sobEDA或sobEDAw方法进行能量分解。与卢天等实现的sobEDA.sh脚本（http://sobereva.com/soft/sobEDA_tutorial.zip）不同，BDF的sobEDA、sobEDAw方法先对分子轨道进行局域化，再进行sobEDA/sobEDAw分析，因此虽然得到的能量分解结果与sobEDA.sh可比，但分子轨道不可比（BDF的局域轨道往往具有更明确的化学意义）。

注意对于sobEDA、sobEDAw而言，分片时会确保片段没有缓冲区，也即每个原子仅属于一个片段，这是进行sobEDA/sobEDAw能量分解分析的必要条件。如用户指定了sobEDA/sobEDAw，但没有指定FragDef，则程序自动打开NonCovalent（见下）。

:guilabel:`nprocs` 参数类型：整数
------------------------------------------------
 * 默认值：1
 * 可选值：小于等于分子片数的正整数

设定iOI计算最大可用进程数。由于分子片计算是独立的，可并行计算，此处nprocs指的即是最多允许多少个分子片同时计算。注意当nprocs不等于1时，环境变量OMP_NUM_THREADS指定的是iOI计算的总OpenMP线程数，而不是每个进程的可用OpenMP线程数。例如当环境变量OMP_NUM_THREADS=16，且nprocs为2时，代表iOI计算中同时最多有2个子体系在并行计算，每个子体系使用8个OpenMP线程。

:guilabel:`radcent`  参数类型： 浮点
-----------------------------------------------
 * 默认值：3.0
 * 可选值：非负浮点数

设定初始分子片（即尚未添加缓冲区的分子片）的大小（单位：埃），增加radcent会增加每个分子片的尺寸，且减少分子片的数目。

:guilabel:`radbuff`  参数类型： 浮点
-----------------------------------------------
 * 默认值：2.0
 * 可选值：非负浮点数

设定分子片缓冲区半径（单位：埃）。与radcent不同，增加radbuff不改变分子片数目，但会增加每个分子片的尺寸。对于iOI计算，radbuff定义的是第0次宏迭代时分子片缓冲区的大小，缓冲区将在宏迭代过程中增大。

:guilabel:`iOIThresh`  参数类型： 浮点
-----------------------------------------------
 * 默认值：0.1
 * 可选值：正浮点数

设定iOI-SCF分子片段计算的收敛阈值。减小iOIThresh会增加iOI计算的宏迭代次数，但改进了整体分子计算的初始轨道，所以会加快整体分子的SCF收敛。

:guilabel:`NoOverlapMetric`  参数类型： Bool
-----------------------------------------------

对于iOI计算，指定基于实空间度规而非重叠积分度规进行分片。仅在对极大的体系（如上万原子体系）进行分片，而且仅进行分片而不对片段进行SCF计算（也即指定DryRun）时，才有必要添加该关键词，可以通过避免计算总体系的重叠矩阵而节约时间。

:guilabel:`NonCovalent`  参数类型： Bool
-----------------------------------------------

在分片时不切断任何共价键。该关键词对于计算非共价复合物，尤其是对非共价复合物做能量分解分析特别有用。

:guilabel:`FragDef`  参数类型： 整数数组
-----------------------------------------------

人为定义哪些原子属于同一个片段。若用户希望将整个分子分为N片，则FragDef后的第一行应当为2N个整数，依次为每个片段的电荷和自旋多重度；第2到第N+1行分别为每个片段的原子序号范围。例如以下写法

.. code-block:: bdf

  $autofrag
  ...
  fragdef
  0 2 1 -2
  1,3-10
  2,11,12
  ...
  $end

表示：（1）将整个分子分为2个片段；（2）第一个片段的电荷为0，自旋多重度为2，第二个片段的电荷为+1，自旋多重度为2，且自旋方向与第一个片段相反；（3）第一个片段由第1个原子和第3~10号原子组成，共9个原子；（4）第二个片段由第2、11、12号原子组成，共3个原子。

注意：（1）FragDef涉及的原子序号必须不重不漏地涵盖整个分子里的所有原子，每个原子必须出现一次，且只能出现一次；（2）上述写法中，","、"-"前后不能添加空格；（3）若按照用户指定的分片方式进行分片会导致切断共价键，则程序自动在用户指定的片段的基础上补充缓冲区；（4）若用户无法确认某些片段的电荷或自旋多重度（尤其当程序会自动补充缓冲区，而用户无法预知补充缓冲区后的片段电荷/自旋多重度时），则可将相应的电荷或自旋多重度用星号"*"代替，程序会自动选择一个能使计算正常进行的值，但在此过程中程序可能需要调整用户设置的其他电荷、自旋多重度值（例如因为电子数奇偶性问题），而且程序自行选取的电荷或自旋多重度不保证是化学上有意义的，用户需自行确认其合理性。

:guilabel:`NoPHO`  参数类型： Bool
-----------------------------------------------

设置不利用 **PHO** (Project Hybrid orbital) ，而是利用连接氢 (**H**) 原子来饱和分子分片时的断键处。使用该关键词时，子体系计算的计算量比默认的 **PHO** 方法稍小，但子体系轨道的精度低，可能导致整体分子的SCF迭代次数增加，乃至使总计算时间增加。

:guilabel:`charge`  参数类型： 整数数组
-----------------------------------------------
 * 默认值：无

设定给定原子的电荷数，用以协助指定分子片段的电荷。当程序难以自动确定某分子片段电子数时，用户可以通过指定电荷来确定分子片段总的电子数。格式如下：

.. code-block:: bdf
  
  charge
  10 +2 25 -1 78 -1

这里，指定第10个原子的电荷数为+2，第25个原子的电荷数为-1，第78个原子的电荷数为-1。原子所属的分子片段电荷数将会依照用户给出的原子电荷数来进行确定。

:guilabel:`spinocc`  参数类型： 整数数组
-----------------------------------------------
 * 默认值：无

设定给定原子的形式自旋，用以协助计算到合适的自旋态。输入格式和 ``charge`` 关键词相同。

.. code-block:: bdf
  
  spinocc
  13 +1 17 -1

这里，指定第13个原子有1个未成对的alpha电子，第17个原子有1个未成对的beta电子。注意，所有的开壳层原子都应该被指定。例如一个体系有两个Cu(II)中心，则两个Cu的形式自旋可以都不指定（此时总体系收敛到哪个自旋态是不确定的），也可以都指定，但是不能只指定其中一个的形式自旋而不指定另外一个的形式自旋；但是如果两个Cu原子之中有一个是Cu(I)，则Cu(I)的形式自旋可以不指定，因为其为闭壳层原子。如果体系有离域的自旋，则应该画出让该自旋局域在某个原子上的共振式，再按该共振式指定形式自旋。例如乙烯自由基阳离子的两个碳原子均带有形式正电荷+0.5和形式自旋+0.5，但是指定形式自旋时应该将其中任意一个碳的形式自旋指定为+1，另一个碳的形式自旋指定为0（因为此时该碳原子是闭壳层原子，相应的形式自旋也可以不用指定），而不能把两个碳原子的形式自旋都指定为+0.5。

:guilabel:`maxiter`  参数类型： 整数
-----------------------------------------------
 * 默认值：50

指定iOI-SCF最大的宏迭代次数。

:guilabel:`Dryrun`  参数类型： Bool
-----------------------------------------------
 * 默认值：False

设定只产生FLMO或iOI-SCF输入文件，而不执行计算。

:guilabel:`sobEDAw_c`  参数类型： 浮点数
-----------------------------------------------
 * 默认值：0.439

sobEDAw方法的参数c。此处的默认值为GB3LYP-D3/def2-TZVPD级别下的参数，如用户所用的理论级别并非该级别，则用户必须手动修改该参数。sobEDAw方法的参数可从sobEDA原始文献 :cite:`sobEDA` 中读取，或用sobEDAw_fit工具（http://sobereva.com/soft/sobEDAw_fit.zip）自行拟合。

:guilabel:`sobEDAw_a`  参数类型： 浮点数
-----------------------------------------------
 * 默认值：0.029

sobEDAw方法的参数a。此处的默认值为GB3LYP-D3/def2-TZVPD级别下的参数，如用户所用的理论级别并非该级别，则用户必须手动修改该参数。

:guilabel:`sobEDAw_r`  参数类型： 浮点数
-----------------------------------------------
 * 默认值：2.351

sobEDAw方法的参数r。此处的默认值为GB3LYP-D3/def2-TZVPD级别下的参数，如用户所用的理论级别并非该级别，则用户必须手动修改该参数。
