结构优化与频率计算
================================================

结构优化的目的是找到体系势能面的极小点。能找到哪个极小点取决于输入文件中提供的初猜结构，离哪个极小点越近，一般越容易收敛到哪个极小点。

结构优化在数学上等价于寻找多元函数极值问题：

.. math::
    F_{i} = -\frac{\partial E(R_1,R_2,\dots,R_N)}{\partial R_i} = 0, i=1,2,\dots,N

结构优化常用算法如下：

#. 最速下降法（Steepest descent）：最速下降法就是沿着负梯度的方向进行线搜索，对于远离极小点的结构，最速下降法优化效率非常高，但临近极小点时收敛慢，容易震荡。
#. 共轭梯度法（Conjugate gradient）：共轭梯度法是最速下降法的改良，每步优化方向与前一步的优化方向相组合,能一定程度缓解震荡问题。
#. 牛顿法（Newton method）：牛顿法的思路是将函数相对于当前位置进行泰勒级数展开。牛顿法收敛很快，对于二次函数一步就可以走到极小点。但是牛顿法需要求解Hessian矩阵，计算非常太昂贵，一般几何优化中使用准牛顿法。
#. 准牛顿法（Quasi-Newton method）：准牛顿法通过近似方法构建 Hessian矩阵，当前步的Hessian矩阵基于当前步的受力和上一步的Hessian矩阵来得到。具体做法有多种，最常用的是BFGS法，还有DFP、MS、PSB等。由于准牛顿法的 Hessian是近似构建的，所以每一步优化的准确度低于牛顿法，达到收敛所需步数更多。但由于每一步耗时大为降低，所以优化总耗时还是显著减少了。

BDF的结构优化是由BDFOPT模块来实现的，支持基于牛顿法和准牛顿法来进行极小值点结构和过渡态结构的优化，且支持限制性结构优化等。以下对BDFOPT模块的输入文件格式以及输出文件的解读进行举例介绍。

基态结构优化：一氯甲烷（CH3Cl）在B3LYP/def2-SV(P)水平下的结构优化
-------------------------------------------------------------------------

.. code-block:: python

    $compass
    title
     CH3Cl geomopt
    basis
     def2-SV(P)
    geometry
     C                  2.67184328    0.03549756   -3.40353093
     H                  2.05038141   -0.21545378   -2.56943947
     H                  2.80438882    1.09651909   -3.44309081
     H                  3.62454948   -0.43911916   -3.29403269
     Cl                 1.90897396   -0.51627638   -4.89053325
    end geometry
    skeleton
    $end

    $bdfopt
    solver
     1
    $end

    $xuanyuan
    direct
    $end

    $scf
    rks
    dft
     b3lyp
    $end

    $resp
    geom
    $end

其中RESP模块负责计算DFT梯度。与其他大部分任务不同，在结构优化任务中，程序并不是按顺序、单次、线性地调用各模块，而是会反复多次调用各模块。具体的调用顺序为：

 1. 运行COMPASS，读取分子结构等信息；
 2. 运行BDFOPT，对结构优化所需的中间量进行初始化；
 3. BDFOPT启动一个独立的BDF进程，用来计算当前结构下的能量和梯度，该进程只执行COMPASS、XUANYUAN、SCF、RESP各模块，而跳过BDFOPT。也即，大部分时候用户会发现有两个BDF进程在彼此独立地运行，其中一个为BDFOPT所属的进程，处于等待状态，而另一个进程则在进行能量和梯度的计算。为避免输出文件过于杂乱，后一个进程的输出会被自动重定向到后缀为''.out.tmp''的文件，从而与BDFOPT模块的输出（一般会被用户重定向到''.out''文件）分开；
 4. 待后一个进程结束时，BDFOPT汇总当前结构的能量和梯度信息，并据此调整分子结构，以期降低体系能量；
 5. BDFOPT根据当前结构的梯度以及当前几何结构步长（geometry step）的大小，判断结构是否收敛，如收敛，或结构优化达到最大迭代次数，则程序结束；如不收敛，则跳至第3步。

因此，''.out''文件只包含COMPASS和BDFOPT模块的输出，可以用来监测结构优化的进程，但不包含SCF迭代、布居分析等信息，后者需要在''.out.tmp''文件中查看。

以上述CH3Cl的结构优化任务为例，可以看到''.out''文件里BDFOPT模块的输出：

.. code-block:: python

       Geometry Optimization step :    1

      Single Point SCF for geometry optimization, also get force.


     ### [bdf_single_point] ### nstate= 1
     Allow rotation to standard orientation.

     BDFOPT run - details of gradient calculations will be written
     into .out.tmp file.

    ...

    ### JOB TYPE = SCF ###
    E_tot= -499.84154693
    Converge= YES

    ### JOB TYPE = RESP_GSGRAD ###
    Energy= -499.841546925072
         1        0.0016714972        0.0041574983       -0.0000013445
         2       -0.0002556962       -0.0006880567        0.0000402277
         3       -0.0002218807       -0.0006861734       -0.0000225761
         4       -0.0003229876       -0.0006350885       -0.0000059774
         5       -0.0008670369       -0.0021403962       -0.0000084046

可以看到BDFOPT调用了BDF程序本身，来计算初猜结构下分子的SCF能量和梯度。SCF和梯度计算的详细输出在''.out.tmp''文件中，而''.out''文件仅摘取能量值、梯度值，以及SCF是否收敛等信息。其中，能量的单位为Hartree，梯度的单位为Hartree/Bohr。

因BDFOPT是在内坐标下优化的结构，为了产生下一步的分子结构，必须先产生分子的内坐标。因此在第一步结构优化时，输出文件还会给出各个内坐标的定义（即参与形成相应的键、键角、二面角的原子编号），以及各个内坐标的值（键长的单位为埃，键角、二面角的单位为度）：

.. code-block:: python

    |******************************************************************************|
           Redundant internal coordinates on Angstrom/Degree

      Name         Definition         Value     Constraint
      R1          1   2               1.0700    No
      R2          1   3               1.0700    No
      R3          1   4               1.0700    No
      R4          1   5               1.7600    No
      A1          2   1   3           109.47    No
      A2          2   1   4           109.47    No
      A3          2   1   5           109.47    No
      A4          3   1   4           109.47    No
      A5          3   1   5           109.47    No
      A6          4   1   5           109.47    No
      D1          4   1   3   2      -120.00    No
      D2          5   1   3   2       120.00    No
      D3          2   1   4   3      -120.00    No
      D4          3   1   4   2       120.00    No
      D5          5   1   4   2      -120.00    No
      D6          5   1   4   3       120.00    No
      D7          2   1   5   3       120.00    No
      D8          2   1   5   4      -120.00    No
      D9          3   1   5   2      -120.00    No
      D10         3   1   5   4       120.00    No
      D11         4   1   5   2       120.00    No
      D12         4   1   5   3      -120.00    No

    |******************************************************************************|

待分子结构更新完成后，程序计算梯度以及几何步长的大小，判断结构优化是否收敛：

.. code-block:: python

                           Force-RMS    Force-Max     Step-RMS     Step-Max
        Conv. tolerance :  0.2000E-03   0.3000E-03   0.8000E-03   0.1200E-02
        Current values  :  0.8833E-02   0.2235E-01   0.2445E-01   0.5934E-01
        Geom. converge  :     No           No           No           No

仅当均方根力（Force-RMS）、最大力（Force-Max）、均方根步长（Step-RMS）、最大步长（Step-Max）的当前值均小于对应的收敛限的时候（也即''Geom. converge''栏均为Yes），程序才认为结构优化收敛。对于本算例，结构优化在第5步时收敛，此时输出信息不仅包含各收敛判据的值，还会明确告知用户几何优化已收敛，并分别以笛卡尔坐标和内坐标的形式打印收敛的分子结构：

.. code-block:: python

        Good Job, Geometry Optimization converged in     5 iterations!

       Molecular Cartesian Coordinates (X,Y,Z) in Angstrom :
          C          -0.93557703       0.15971089       0.58828595
          H          -1.71170348      -0.52644336       0.21665897
          H          -1.26240747       1.20299703       0.46170050
          H          -0.72835075      -0.04452039       1.64971607
          Cl          0.56770184      -0.09691413      -0.35697029

                           Force-RMS    Force-Max     Step-RMS     Step-Max
        Conv. tolerance :  0.2000E-03   0.3000E-03   0.8000E-03   0.1200E-02
        Current values  :  0.1736E-05   0.4355E-05   0.3555E-04   0.6607E-04
        Geom. converge  :     Yes          Yes          Yes          Yes


      Print Redundant internal coordinates of the converged geometry

    |******************************************************************************|
           Redundant internal coordinates on Angstrom/Degree

      Name         Definition         Value     Constraint
      R1          1   2               1.1006    No
      R2          1   3               1.1006    No
      R3          1   4               1.1006    No
      R4          1   5               1.7942    No
      A1          2   1   3           110.04    No
      A2          2   1   4           110.04    No
      A3          2   1   5           108.89    No
      A4          3   1   4           110.04    No
      A5          3   1   5           108.89    No
      A6          4   1   5           108.89    No
      D1          4   1   3   2      -121.43    No
      D2          5   1   3   2       119.28    No
      D3          2   1   4   3      -121.43    No
      D4          3   1   4   2       121.43    No
      D5          5   1   4   2      -119.28    No
      D6          5   1   4   3       119.29    No
      D7          2   1   5   3       120.00    No
      D8          2   1   5   4      -120.00    No
      D9          3   1   5   2      -120.00    No
      D10         3   1   5   4       120.00    No
      D11         4   1   5   2       120.00    No
      D12         4   1   5   3      -120.00    No

    |******************************************************************************|

与此同时，程序还会产生后缀为''.optgeom''的文件，其内容是收敛的分子结构的笛卡尔坐标，但单位为Bohr而非Angstrom：

.. code-block:: python

    GEOM
            C             -0.7303234729        -2.0107211546        -0.0000057534
            H             -0.5801408002        -2.7816264533         1.9257943885
            H              0.4173171420        -3.1440530286        -1.3130342173
            H             -2.7178161476        -2.0052051760        -0.6126883555
            Cl             0.4272106261         1.1761889168        -0.0000021938

''.optgeom''文件可以用''$BDFHOME/sbin/''下的工具''optgeom2xyz.py''转为xyz格式，从而可以在支持xyz格式的任何可视化软件里观看优化后的分子结构。例如如果待转换的文件名为filename.optgeom，则在命令行执行：（注意必须先设定环境变量$BDFHOME，或手动用BDF文件夹的路径替代下述命令里的$BDFHOME）

.. code-block:: bash

    $BDFHOME/sbin/optgeom2xyz.py filename

即可在当前目录下得到filename.xyz。

频率计算：CH3Cl在平衡结构下的谐振频率及热力学量的计算
-------------------------------------------------------

结构优化收敛后，即可进行频率分析。准备以下输入文件：

.. code-block:: python

    $compass
    title
     CH3Cl freq
    basis
     def2-SV(P)
    geometry
          C          -0.93557703       0.15971089       0.58828595
          H          -1.71170348      -0.52644336       0.21665897
          H          -1.26240747       1.20299703       0.46170050
          H          -0.72835075      -0.04452039       1.64971607
          Cl          0.56770184      -0.09691413      -0.35697029
    end geometry
    skeleton
    $end

    $bdfopt
    hess
     only
    $end

    $xuanyuan
    direct
    $end

    $scf
    rks
    dft
     b3lyp
    $end

    $resp
    geom
    $end

其中分子结构为上述结构优化任务得到的收敛的结构。注意我们在BDFOPT模块中添加了''hess only''，其中''hess''代表计算（数值）Hessian，而''only''的含义将在后续章节详述。程序将分子的每个原子分别向x轴正方向、x轴负方向、y轴正方向、y轴负方向、z轴正方向、z轴负方向进行扰动，并计算扰动的结构下的梯度，如：

.. code-block:: python

     Displacing atom    1 (+x)...

     ### [bdf_single_point] ### nstate= 1
     Do not allow rotation to standard orientation.

     BDFOPT run - details of gradient calculations will be written
     into .out.tmp file.

    ...

    ### JOB TYPE = SCF ###
    E_tot= -499.84157717
    Converge= YES

    ### JOB TYPE = RESP_GSGRAD ###
    Energy= -499.841577166026
         1        0.0005433780       -0.0000683370       -0.0000066851
         2       -0.0000516384        0.0000136326       -0.0000206081
         3       -0.0001360377        0.0000872513        0.0000990006
         4       -0.0003058645        0.0000115926       -0.0000775624
         5       -0.0000498284       -0.0000354732        0.0000023346

若体系的原子数为N，则共需计算6N个梯度。然而实际上程序还会顺便计算未扰动的结构的梯度，以供用户检查前述结构优化是否确实已经收敛，因此程序实际共计算6N+1个梯度。最后程序通过有限差分方法得到体系的Hessian：

.. code-block:: python

    |--------------------------------------------------------------------------------|
              Molecular Hessian - Numerical Hessian (BDFOPT)

                          1              2              3              4              5              6
           1   0.5443095266  -0.0744293569  -0.0000240515  -0.0527420800   0.0127361607  -0.0209022664
           2  -0.0744293569   0.3693301504  -0.0000259750   0.0124150102  -0.0755387479   0.0935518380
           3  -0.0000240515  -0.0000259750   0.5717632089  -0.0213157291   0.0924260912  -0.2929392390
           4  -0.0527420800   0.0124150102  -0.0213157291   0.0479752418  -0.0069459473   0.0239610358
           5   0.0127361607  -0.0755387479   0.0924260912  -0.0069459473   0.0867377886  -0.0978524147
           6  -0.0209022664   0.0935518380  -0.2929392390   0.0239610358  -0.0978524147   0.3068416997
           7  -0.1367366097   0.0869338594   0.0987840786   0.0031968314  -0.0034098009  -0.0016497426
           8   0.0869913627  -0.1185605401  -0.0945336434  -0.0070787068   0.0099076105   0.0045621064
           9   0.0986508197  -0.0953400774  -0.1659434327   0.0163191407  -0.0140134399  -0.0166739137
          10  -0.3054590932   0.0111756577  -0.0774713107   0.0016297078   0.0019657599  -0.0021771884
          11   0.0112823039  -0.0407134661   0.0021058508   0.0106623780   0.0018506067   0.0005120364
          12  -0.0775840113   0.0018141942  -0.0759448618  -0.0275602878   0.0006820252  -0.0059830018
          13  -0.0486857506  -0.0362556088   0.0000641125  -0.0000787206  -0.0045253276   0.0011289985
          14  -0.0360823429  -0.1334063062   0.0000148321  -0.0091074064  -0.0228930763  -0.0010993076
          15   0.0001686252   0.0004961854  -0.0352553706   0.0084860406   0.0189117305   0.0079690194

                          7              8              9             10             11             12
           1  -0.1367366097   0.0869913627   0.0986508197  -0.3054590932   0.0112823039  -0.0775840113
           2   0.0869338594  -0.1185605401  -0.0953400774   0.0111756577  -0.0407134661   0.0018141942
           3   0.0987840786  -0.0945336434  -0.1659434327  -0.0774713107   0.0021058508  -0.0759448618
           4   0.0031968314  -0.0070787068   0.0163191407   0.0016297078   0.0106623780  -0.0275602878
           5  -0.0034098009   0.0099076105  -0.0140134399   0.0019657599   0.0018506067   0.0006820252
           6  -0.0016497426   0.0045621064  -0.0166739137  -0.0021771884   0.0005120364  -0.0059830018
           7   0.1402213115  -0.0861503922  -0.1081442631  -0.0130805143   0.0143574755   0.0192323598
           8  -0.0861503922   0.1322736798   0.1009922720   0.0016534140   0.0024111759   0.0011733340
           9  -0.1081442631   0.1009922720   0.1688786678  -0.0038440081   0.0072277457   0.0091535975
          10  -0.0130805143   0.0016534140  -0.0038440081   0.3186765202  -0.0079165663   0.0838593213
          11   0.0143574755   0.0024111759   0.0072277457  -0.0079165663   0.0509206668  -0.0029665370
          12   0.0192323598   0.0011733340   0.0091535975   0.0838593213  -0.0029665370   0.0707430980
          13   0.0064620333   0.0044161973  -0.0031236007  -0.0026369496  -0.0283860480   0.0017966445
          14  -0.0119743475  -0.0258901434   0.0013817613  -0.0066143965  -0.0145372292  -0.0006143935
          15  -0.0078330845  -0.0126024853   0.0040383425  -0.0008566397  -0.0068931757   0.0018028482

                         13             14             15
           1  -0.0486857506  -0.0360823429   0.0001686252
           2  -0.0362556088  -0.1334063062   0.0004961854
           3   0.0000641125   0.0000148321  -0.0352553706
           4  -0.0000787206  -0.0091074064   0.0084860406
           5  -0.0045253276  -0.0228930763   0.0189117305
           6   0.0011289985  -0.0010993076   0.0079690194
           7   0.0064620333  -0.0119743475  -0.0078330845
           8   0.0044161973  -0.0258901434  -0.0126024853
           9  -0.0031236007   0.0013817613   0.0040383425
          10  -0.0026369496  -0.0066143965  -0.0008566397
          11  -0.0283860480  -0.0145372292  -0.0068931757
          12   0.0017966445  -0.0006143935   0.0018028482
          13   0.0450796910   0.0642866688   0.0000350066
          14   0.0642866688   0.1954779468   0.0000894464
          15   0.0000350066   0.0000894464   0.0213253497

    |--------------------------------------------------------------------------------|

其中第3N+1（3N+2、3N+3）行对应第N个原子的x（y、z）坐标，第3N+1（3N+2、3N+3）列同理。

接下来BDF调用UniMoVib程序进行频率和热力学量的计算。首先是振动所属不可约表示、振动频率、约化质量、力常数和简正模的结果：

.. code-block:: python

     ************************************
     ***  Properties of Normal Modes  ***
     ************************************

     Results of vibrations:
     Normal frequencies (cm^-1), reduced masses (AMU), force constants (mDyn/A)

                                                       1                                 2                                 3
              Irreps                                  A1                                 E                                 E
         Frequencies                            733.9170                         1020.5018                         1021.2363
      Reduced masses                              7.2079                            1.1701                            1.1699
     Force constants                              2.2875                            0.7179                            0.7189
            Atom  ZA               X         Y         Z             X         Y         Z             X         Y         Z
               1   6        -0.21108  -0.57499  -0.00106      -0.04882   0.01679   0.10300       0.09664  -0.03546   0.05161
               2   1        -0.13918  -0.40351   0.04884      -0.06700  -0.59986  -0.13376      -0.37214  -0.36766  -0.03443
               3   1        -0.11370  -0.42014  -0.03047       0.26496   0.65294  -0.15254      -0.28591  -0.18743  -0.15504
               4   1        -0.19549  -0.38777  -0.01079       0.05490  -0.14087  -0.24770       0.15594   0.73490  -0.07808
               5  17         0.08533   0.23216   0.00014       0.00947  -0.00323  -0.01995      -0.01869   0.00699  -0.01000

其中各振动模式是按振动频率从小到大的顺序排列的，而虚频排在所有实频的前面，因此只需检查前几个频率，即可得知虚频的数目。接下来打印热化学分析结果：

.. code-block:: python

     *********************************************
     ***   Thermal Contributions to Energies   ***
     *********************************************

     Molecular mass            :        49.987388    AMU
     Electronic total energy   :      -499.841576    Hartree
     Scaling factor of Freq.   :         1.000000
     Tolerance of scaling      :         0.000000    cm^-1
     Rotational symmetry number:         3
     The C3v  point group is used to calculate rotational entropy.

     Principal axes and moments of inertia in atomic units:
                                         1                   2                   3
         Eigenvalues --                 11.700793          137.571621          137.571665
               X                         0.345094            0.938568           -0.000000
               Y                         0.938568           -0.345094           -0.000000
               Z                         0.000000            0.000000            1.000000

     Rotational temperatures             7.402388            0.629591            0.629591    Kelvin
     Rot. constants A, B, C              5.144924            0.437588            0.437588    cm^-1
                                       154.240933           13.118557           13.118553    GHz


     #   1    Temperature =       298.15000 Kelvin         Pressure =         1.00000 Atm
     ====================================================================================

     Thermal correction energies                              Hartree            kcal/mol
     Zero-point Energy                          :            0.037519           23.543449
     Thermal correction to Energy               :            0.040539           25.438450
     Thermal correction to Enthalpy             :            0.041483           26.030936
     Thermal correction to Gibbs Free Energy    :            0.014881            9.338203

     Sum of electronic and zero-point Energies  :         -499.804057
     Sum of electronic and thermal Energies     :         -499.801038
     Sum of electronic and thermal Enthalpies   :         -499.800093
     Sum of electronic and thermal Free Energies:         -499.826695
     ====================================================================================

用户可根据需要读取零点能、焓、Gibbs自由能等数据。

过渡态结构优化：HCN/HNC异构反应的过渡态优化
-------------------------------------------------------

To be done

限制性结构优化
-------------------------------------------------------

几何优化常见问题
-------------------------------------------------------

虚频问题
########################################################

对称性问题
########################################################

几何优化不收敛
########################################################

