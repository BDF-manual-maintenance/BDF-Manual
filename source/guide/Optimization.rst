势能面和几何优化
================================================

几何优化的目的是找到体系势能面的极小点。能找到哪个极小点取决于输入文件中提供的初猜结构，离哪个极小点越近，一般越容易收敛到哪个极小点。

几何优化在数学上等价于寻找多元函数极值问题：

.. math::
    F_{i} = -\frac{\partial E(R_1,R_2,\dots,R_N)}{\partial R_i} = 0, i=1,2,\dots,N

几何优化常用算法如下：

#. 最速下降法（Steepest descent）：最速下降法就是沿着负梯度的方向进行线搜索，对于远离极小点的结构，最速下降法优化效率非常高，但临近极小点时收敛慢，容易震荡。
#. 共轭梯度法（Conjugate gradient）：共轭梯度法是最速下降法的改良，每步优化方向与前一步的优化方向相组合,能一定程度缓解震荡问题。
#. 牛顿法（Newton method）：牛顿法的思路是将函数相对于当前位置进行泰勒级数展开。牛顿法收敛很快，对于二次函数一步就可以走到极小点。但是牛顿法需要求解Hessian矩阵，计算非常太昂贵，一般几何优化中使用准牛顿法。
#. 准牛顿法（Quasi-Newton method）：准牛顿法通过近似方法构建 Hessian矩阵，当前步的Hessian矩阵基于当前步的受力和上一步的Hessian矩阵来得到。具体做法有多种，最常用的是BFGS法，还有DFP、MS、PSB等。由于准牛顿法的 Hessian是近似构建的，所以每一步优化的准确度低于牛顿法，达到收敛所需步数更多。但由于每一步耗时大为降低，所以优化总耗时还是显著减少了。

BDFpro的结构优化是由BDFOPT模块来实现的，支持基于牛顿法和准牛顿法来进行极小值点结构和过渡态结构的优化，且支持限制性结构优化等。以下对BDFOPT模块的输入文件格式以及输出文件的解读进行举例介绍。

基态结构优化：一氯甲烷（CH3Cl）在B3LYP/def2-SV(P)水平下的结构优化
-------------------------------------------------------

.. code-block:: python

    $compass
    title
     CH3Cl geomopt
    basis
     def2-SV(P)
    geometry
     C                  2.67184328    0.03549756   -3.40353093
     H                  2.05038141   -0.21545378   -2.56943947
     H                  2.80438882    1.09651909   -3.44309081
     H                  3.62454948   -0.43911916   -3.29403269
     Cl                 1.90897396   -0.51627638   -4.89053325
    end geometry
    skeleton
    $end

    $bdfopt
    solver
     1
    $end

    $xuanyuan
    direct
    $end

    $scf
    rks
    dft
     b3lyp
    $end

    $resp
    geom
    $end

其中RESP模块负责计算DFT梯度。与其他大部分任务不同，在结构优化任务中，程序各模块的执行顺序并不是单次、线性的，而是会反复多次调用各模块。具体的调用顺序为：

 1. 运行COMPASS，读取分子结构等信息；
 2. 运行BDFOPT，对结构优化所需的中间量进行初始化；
 3. BDFOPT启动一个独立的BDFpro进程，用来计算当前结构下的能量和梯度，该进程只执行COMPASS、XUANYUAN、SCF、RESP各模块，而跳过BDFOPT。也即，大部分时候用户会发现有两个BDFpro进程在彼此独立地运行，其中一个为BDFOPT所属的进程，处于等待状态，而另一个进程则在进行能量和梯度的计算。为避免输出文件过于杂乱，后一个进程的输出会被自动重定向到后缀为''.out.tmp''的文件，从而与BDFOPT模块的输出（一般会被用户重定向到''.out''文件）分开；
 4. 待后一个进程结束时，BDFOPT汇总当前结构的能量和梯度信息，并据此调整分子结构，以期降低体系能量；
 5. BDFOPT根据当前结构的梯度以及当前几何结构步长（geometry step）的大小，判断结构是否收敛，如收敛，或结构优化达到最大迭代次数，则程序结束；如不收敛，则跳至第3步。

To be done...

激发态结构优化
-------------------------------------------------------

限制性结构优化
-------------------------------------------------------

几何优化常见问题
-------------------------------------------------------

虚频问题
########################################################

对称性问题
########################################################

几何优化不收敛
########################################################

